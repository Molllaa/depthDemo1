(this.webpackJsonpdemo=this.webpackJsonpdemo||[]).push([[0],{257:function(e,t,n){var r=n(310),a=["isModelLoaded","switchModel","infer"];e.exports=function(){var e=new Worker(n.p+"5048cbc94aa7c76adbed.worker.js",{name:"[hash].worker.js"});return r(e,a),e}},287:function(e,t,n){},289:function(e,t,n){},296:function(e,t){},297:function(e,t){},305:function(e,t){},308:function(e,t){},309:function(e,t){},311:function(e,t,n){"use strict";n.r(t);var r=n(36),a=n(32),c=n.n(a),i=n(236),o=n.n(i),s=(n(287),n(68)),u=n(5),l=n.n(u),d=n(14),h=n(8),j=(n(289),n(259)),b=n(109),v=n(257),f=n.n(v),m=function(e){var t=e.data,n=e.shape;return b.c(t,n)},p=n(1),g=n(258),O=function(e){var t=e.inputImage,n=e.depthMapImage,c=e.viewMode,i=e.mousePosition,o=e.orientation,s=e.parallaxStrength,u=e.focus,l=e.zoom,d=Object(a.useRef)(null),h=Object(a.useRef)(null),j=Object(a.useRef)(null),b=Object(a.useRef)(null),v=Object(a.useRef)(null),f=Object(a.useRef)(null),m=Object(a.useRef)(null),O=Object(a.useRef)(null),x=Object(a.useCallback)((function(){if(d.current&&h.current&&b.current&&d.current.parentElement){var e=d.current.parentElement,t=e.clientWidth,n=e.clientHeight;if(h.current.setSize(t,n),b.current.aspect=t/n,b.current.updateProjectionMatrix(),O.current&&f.current){var r,a=f.current.image.width/f.current.image.height,c=b.current.fov,i=b.current.position.z,o=t/n,s=2*Math.tan(p.mb.degToRad(c/2))*i;r=o>a?s/1:s*o/a,O.current.scale.set(r,r,1)}}}),[]);Object(a.useEffect)((function(){var e=d.current,t=new g.a({canvas:e,antialias:!0});t.setSize(e.clientWidth,e.clientHeight),t.setPixelRatio(window.devicePixelRatio),h.current=t;var n=new p.Uc;j.current=n;var r=new p.Wb(45,e.clientWidth/e.clientHeight,.1,1e3);r.position.z=2,b.current=r;new p.Yb(1,1);var a=new p.Vc({vertexShader:"\n  attribute float depth;\n  varying vec2 vUv;\n  uniform vec2 mouseDelta;\n  uniform float focus;\n  uniform float meshDepth;\n  uniform float sensitivity;\n\n  void main() {\n    vUv = uv;\n    vec3 pos = position;\n\n    float actualDepth = depth * meshDepth;\n    float focusDepth = focus * meshDepth;\n\n    // Rotational displacement (relative to focus depth)\n    vec2 rotate = mouseDelta * sensitivity * \n        (1.0 - focus) * \n        (actualDepth - focusDepth) * \n        vec2(-1.0, 1.0);\n\n    // Calculate edge proximity factor (0 at edges, 1 in center)\n    float edgeWidth = 0.01; // controls edge stiffness\n    vec2 edgeFactorVec = smoothstep(0.0, edgeWidth, vUv) * \n                        smoothstep(1.0, 1.0 - edgeWidth, vUv);\n    float edgeFactor = edgeFactorVec.x * edgeFactorVec.y;\n\n    // Apply displacement with edge preservation\n    pos.xy += rotate * edgeFactor;\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n  }\n",fragmentShader:"\n  uniform sampler2D u_image;\n  varying vec2 vUv;\n\n  void main() {\n    gl_FragColor = texture2D(u_image, vUv);\n  }\n",uniforms:{u_image:{value:null},mouseDelta:{value:new p.qd(0,0)},focus:{value:u},meshDepth:{value:1},sensitivity:{value:.5}}});v.current=a;return function e(){requestAnimationFrame(e),t.render(n,r)}(),window.addEventListener("resize",x),x(),function(){window.removeEventListener("resize",x),h.current&&h.current.dispose(),f.current&&f.current.dispose(),m.current&&m.current.dispose()}}),[x]),Object(a.useEffect)((function(){v.current&&t&&(f.current&&f.current.dispose(),(new p.ed).load(t,(function(e){f.current=e,v.current.uniforms.u_image.value=e})))}),[t]);return Object(a.useEffect)((function(){if(O.current&&(j.current.remove(O.current),O.current.geometry.dispose(),O.current=null),v.current&&n&&j.current){var e=new Image;e.src=n,e.onload=function(){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var n=t.getContext("2d");n.drawImage(e,0,0);var r=function(e){for(var t=e.width,n=e.height,r=t/n,a=new p.Yb(r,1,t-1,n-1),c=a.attributes.position.array,i=new Float32Array(c.length/3),o=0;o<c.length;o+=3){var s=o/3,u=a.attributes.uv.array[2*s],l=1-a.attributes.uv.array[2*s+1],d=Math.floor(u*(t-1)),h=4*(Math.floor(l*(n-1))*t+d),j=e.data[h]/255;c[o+2]=j,i[s]=j}return a.setAttribute("depth",new p.l(i,1)),a.attributes.position.needsUpdate=!0,a}(n.getImageData(0,0,e.width,e.height)),a=new p.qb(r,v.current);O.current=a;var c,i=b.current.fov,o=b.current.position.z,s=d.current.clientWidth/d.current.clientHeight,u=e.width/e.height,l=2*Math.tan(p.mb.degToRad(i/2))*o;c=s>u?l/1:l*s/u,a.scale.set(c,c,1),j.current.add(a)}}}),[n]),Object(a.useEffect)((function(){if(v.current){var e=0,t=0;"mouse"===c&&i?(e=2*i.x-1,t=2*i.y-1):"gyro"===c&&o?(e=o.gamma/-30,t=o.beta/-60):"gyroInverse"===c&&o&&(e=o.gamma/30,t=o.beta/60);var n=v.current.uniforms.mouseDelta.value;n.x+=.05*(e-n.x),n.y+=.05*(t-n.y)}}),[i,o,c]),Object(a.useEffect)((function(){v.current&&(v.current.uniforms.focus.value=u)}),[u]),Object(a.useEffect)((function(){v.current&&(v.current.uniforms.sensitivity.value=10*s)}),[s]),Object(a.useEffect)((function(){b.current&&(b.current.position.z=2/l,b.current.updateProjectionMatrix())}),[l]),Object(r.jsx)("canvas",{ref:d,className:"main-view-canvas"})};var x=function(){var e=Object(a.useRef)(null),t=Object(a.useState)(""),n=Object(h.a)(t,2),c=n[0],i=n[1],o=Object(a.useState)(null),u=Object(h.a)(o,2),v=u[0],p=u[1],g=Object(a.useState)(!1),x=Object(h.a)(g,2),w=x[0],y=x[1],M=Object(a.useRef)(null),R=Object(a.useRef)(null),S=Object(a.useState)(!1),k=Object(h.a)(S,2),E=k[0],D=k[1],F=Object(a.useState)(!1),z=Object(h.a)(F,2),C=z[0],N=z[1],I=Object(a.useState)(/Mobi|Android/i.test(navigator.userAgent)?"gyro":"mouse"),P=Object(h.a)(I,2),W=P[0],A=P[1],L=Object(a.useState)({x:.5,y:.5}),T=Object(h.a)(L,2),U=T[0],H=T[1],_=Object(a.useState)(null),V=Object(h.a)(_,2),q=V[0],X=V[1],Y=Object(a.useRef)(null),B=Object(a.useState)(!1),J=Object(h.a)(B,2),G=J[0],K=J[1],Q=Object(a.useState)(.025),Z=Object(h.a)(Q,2),$=Z[0],ee=Z[1],te=Object(a.useState)(.75),ne=Object(h.a)(te,2),re=ne[0],ae=ne[1],ce=Object(a.useState)(!1),ie=Object(h.a)(ce,2),oe=ie[0],se=ie[1],ue=Object(a.useState)(.9),le=Object(h.a)(ue,2),de=le[0],he=le[1],je=Object(a.useState)("depthAnything"),be=Object(h.a)(je,2),ve=be[0],fe=be[1],me=Object(a.useState)(0),pe=Object(h.a)(me,2),ge=pe[0],Oe=pe[1];Object(a.useEffect)((function(){e.current=new f.a;var t=function(){var n=Object(d.a)(l.a.mark((function n(){var r;return l.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,e.current.isModelLoaded(ve);case 3:r=n.sent,N(r),r||setTimeout(t,1e3),n.next=12;break;case 8:n.prev=8,n.t0=n.catch(0),console.error("Error checking model loaded status:",n.t0),setTimeout(t,1e3);case 12:case"end":return n.stop()}}),n,null,[[0,8]])})));return function(){return n.apply(this,arguments)}}();t()}),[]),Object(a.useEffect)((function(){e.current&&(N(!1),e.current.switchModel(ve).then((function(t){if(t){var n=function(){var t=Object(d.a)(l.a.mark((function t(){var r;return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.current.isModelLoaded(ve);case 3:r=t.sent,N(r),r?c&&!E&&xe():setTimeout(n,1e3),t.next=12;break;case 8:t.prev=8,t.t0=t.catch(0),console.error("Error checking model loaded status:",t.t0),setTimeout(n,1e3);case 12:case"end":return t.stop()}}),t,null,[[0,8]])})));return function(){return t.apply(this,arguments)}}();n()}})))}),[ve]),Object(a.useEffect)((function(){if(window.DeviceOrientationEvent){K(!0);var e=function(e){"gyro"!==W&&"gyroInverse"!==W||X({alpha:e.alpha,beta:e.beta,gamma:e.gamma})};return window.addEventListener("deviceorientation",e),function(){window.removeEventListener("deviceorientation",e)}}K(!1)}),[W]);var xe=Object(a.useCallback)(Object(d.a)(l.a.mark((function t(){var n,r,a,c,i,o,s,u,d,h,j,v;return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.current){t.next=4;break}return console.error("Inference worker is not initialized yet."),alert("Worker not ready, please try again shortly."),t.abrupt("return");case 4:if(C){t.next=8;break}return console.error("Model is not loaded yet."),alert("\u6a21\u578b\u5c1a\u672a\u52a0\u8f7d\u5b8c\u6210\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002"),t.abrupt("return");case 8:if(!E&&M.current&&M.current.src&&""!==M.current.src&&0!==M.current.naturalWidth&&0!==M.current.naturalHeight){t.next=10;break}return t.abrupt("return");case 10:return D(!0),R.current&&R.current.getContext("2d").clearRect(0,0,R.current.width,R.current.height),p(null),y(!1),t.prev=14,n=M.current.naturalHeight,r=M.current.naturalWidth,c=n,i=r,(n>(a=4096)||r>a)&&(o=r/n,n>r?(c=a,(i=Math.floor(c*o))>a&&(i=a,c=Math.floor(i/o))):(i=a,(c=Math.floor(i/o))>a&&(c=a,i=Math.floor(c*o))),console.log("\u56fe\u50cf\u5c3a\u5bf8(".concat(r,"x").concat(n,")\u8d85\u8fc7WebGL\u9650\u5236\uff0c\u5df2\u8c03\u6574\u4e3a").concat(i,"x").concat(c))),(s=document.createElement("canvas")).width=i,s.height=c,s.getContext("2d").drawImage(M.current,0,0,i,c),u=b.a.fromPixels(s),d=[c,i],4===u.shape[2]&&(u=u.slice([0,0,0],[u.shape[0],u.shape[1],3])),h={data:(l=u).dataSync(),shape:l.shape},u.dispose(),t.t0=m,t.next=34,e.current.infer(h);case 34:if(t.t1=t.sent,j=(0,t.t0)(t.t1),j=b.b.resizeBilinear(j,d),!R.current){t.next=42;break}return R.current.width=d[1],R.current.height=d[0],t.next=42,b.a.toPixels(j,R.current);case 42:return(v=document.createElement("canvas")).width=d[1],v.height=d[0],t.next=47,b.a.toPixels(j.clone(),v);case 47:p(v.toDataURL()),y(!0),j.dispose(),t.next=56;break;case 52:t.prev=52,t.t2=t.catch(14),console.error("Inference error:",t.t2),t.t2.message&&t.t2.message.includes("Requested texture size")?alert("\u56fe\u50cf\u5c3a\u5bf8\u8fc7\u5927\uff0c\u5df2\u81ea\u52a8\u8c03\u6574\u3002\u8bf7\u91cd\u8bd5\u6216\u9009\u62e9\u8f83\u5c0f\u7684\u56fe\u7247\u3002"):alert("\u63a8\u7406\u8fc7\u7a0b\u4e2d\u53d1\u751f\u9519\u8bef\uff0c\u8bf7\u91cd\u8bd5\u6216\u9009\u62e9\u5176\u4ed6\u56fe\u7247\u3002");case 56:return t.prev=56,D(!1),t.finish(56);case 59:case"end":return t.stop()}var l}),t,null,[[14,52,56,59]])}))),[E,M,R,p,D,ve,C]),we=Object(a.useCallback)((function(e){if(!E&&C){var t=new FileReader;t.onload=function(){if(i(t.result),p(null),y(!1),R.current){var e=R.current.getContext("2d");R.current.width>0&&R.current.height>0&&e.clearRect(0,0,R.current.width,R.current.height)}},t.readAsDataURL(e[0])}}),[i,p,E,R,C]),ye=Object(j.a)({onDrop:we,accept:"image/*"}),Me=ye.getRootProps,Re=ye.getInputProps,Se=ye.isDragActive,ke=function(e){if("mouse"===W&&Y.current){var t=Y.current.getBoundingClientRect(),n=e.touches?e.touches[0].clientX:e.clientX,r=e.touches?e.touches[0].clientY:e.clientY,a=(n-t.left)/t.width,c=(r-t.top)/t.height;H({x:Math.max(0,Math.min(1,a)),y:Math.max(0,Math.min(1,1-c))})}},Ee=function(){se(!oe)};return Object(r.jsxs)("div",{className:"app-container",children:[Object(r.jsxs)("button",{className:"hamburger-menu",onClick:Ee,children:[Object(r.jsx)("span",{}),Object(r.jsx)("span",{}),Object(r.jsx)("span",{})]}),oe&&Object(r.jsx)("div",{className:"overlay",onClick:Ee}),Object(r.jsxs)("aside",{className:"sidebar ".concat(oe?"sidebar--open":""),onTouchStart:function(e){Oe(e.touches[0].clientX)},onTouchMove:function(e){oe&&(e.touches[0].clientX-ge<-50&&se(!1))},children:[Object(r.jsx)("h2",{children:"\u63a7\u5236\u53f0"}),Object(r.jsxs)("div",{className:"control-group",children:[Object(r.jsx)("label",{htmlFor:"modelSelect",children:"\u9009\u62e9\u6a21\u578b"}),Object(r.jsxs)("select",{id:"modelSelect",value:ve,onChange:function(e){return fe(e.target.value)},children:[Object(r.jsx)("option",{value:"depthAnything",children:"DepthAnything"}),Object(r.jsx)("option",{value:"midas",children:"Midas"})]}),Object(r.jsx)("label",{htmlFor:"viewModeSelect",children:"\u63a7\u5236\u6a21\u5f0f"}),Object(r.jsxs)("select",{id:"viewModeSelect",value:W,onChange:function(e){return A(e.target.value)},children:[Object(r.jsx)("option",{value:"mouse",children:"\u9f20\u6807"}),G&&Object(r.jsx)("option",{value:"gyro",children:"\u9640\u87ba\u4eea"}),G&&Object(r.jsx)("option",{value:"gyroInverse",children:"\u9640\u87ba\u4eea(\u53cd\u5411)"})]}),!G&&("gyro"===W||"gyroInverse"===W)&&Object(r.jsx)("p",{style:{color:"orange"},children:"\u9640\u87ba\u4eea\u4e0d\u53ef\u7528\u6216\u4e0d\u652f\u6301\u3002"})]}),Object(r.jsxs)("div",{className:"control-group",children:[Object(r.jsxs)("label",{htmlFor:"parallaxStrengthRange",children:["\u4f4d\u79fb\u5f3a\u5ea6: ",$.toFixed(3)]}),Object(r.jsx)("input",{type:"range",id:"parallaxStrengthRange",min:"0.001",max:"0.1",step:"0.001",value:$,onChange:function(e){return ee(parseFloat(e.target.value))},onTouchMove:function(e){return e.stopPropagation()}})]}),Object(r.jsxs)("div",{className:"control-group",children:[Object(r.jsxs)("label",{htmlFor:"focusRange",children:["\u7126\u70b9: ",re.toFixed(2)]}),Object(r.jsx)("input",{type:"range",id:"focusRange",min:"0.0",max:"1.0",step:"0.01",value:re,onChange:function(e){return ae(parseFloat(e.target.value))},onTouchMove:function(e){return e.stopPropagation()}})]}),Object(r.jsxs)("div",{className:"image-preview-area",children:[Object(r.jsx)("h3",{children:"\u539f\u59cb\u56fe\u50cf"}),Object(r.jsxs)("div",Object(s.a)(Object(s.a)({className:["image-dropzone",C?Se?"image-dropzone--highlight":"image-dropzone--default":"image-dropzone--disabled"].join(" ")},C?Me():{}),{},{children:[C&&Object(r.jsx)("input",Object(s.a)({},Re())),c?Object(r.jsx)("img",{ref:M,alt:"Input",src:c,className:"preview-image",onLoad:C?xe:void 0}):Object(r.jsx)("p",{children:C?"\u70b9\u51fb\u4e0a\u4f20\uff0c\u6216\u62d6\u62fd\u56fe\u7247\u81f3\u6b64\u5904":"\u6a21\u578b\u52a0\u8f7d\u4e2d..."})]}))]}),Object(r.jsxs)("div",{className:"image-preview-area",children:[Object(r.jsx)("h3",{children:"\u6df1\u5ea6\u56fe"}),Object(r.jsx)("canvas",{ref:R,className:"preview-image"})]}),Object(r.jsx)("button",{onClick:xe,disabled:E||!c||!C,children:E?"\u751f\u6210\u4e2d...":C?"\u751f\u6210\u6df1\u5ea6\u56fe":"\u6a21\u578b\u52a0\u8f7d\u4e2d..."}),Object(r.jsx)("div",{className:"made-by-text",children:"Made by J"})]}),Object(r.jsxs)("main",{className:"main-content",onMouseMove:ke,onTouchMove:ke,ref:Y,children:[Object(r.jsx)("h1",{className:"main-title",children:"\u5355\u76ee\u6df1\u5ea6\u56fe\u4f30\u7b97"}),Object(r.jsxs)("div",{className:"webgl-viewer-container",children:[E&&!w&&Object(r.jsx)("div",{className:"loading-overlay",children:Object(r.jsx)("p",{children:"\u751f\u6210\u4e2d..."})}),Object(r.jsx)(O,{inputImage:c,depthMapImage:w?v:null,viewMode:W,mousePosition:U,orientation:q,parallaxStrength:$,focus:re,zoom:de}),Object(r.jsxs)("div",{className:"viewer-controls",children:[Object(r.jsx)("button",{onClick:function(){he(.9),H({x:.5,y:.5})},children:"\u91cd\u7f6e"}),Object(r.jsxs)("label",{htmlFor:"zoomRange",children:[de.toFixed(2),"x"]}),Object(r.jsx)("input",{type:"range",id:"zoomRange",min:"0.1",max:"1.5",step:"0.1",value:de,onChange:function(e){return he(parseFloat(e.target.value))}})]})]})]})]})};o.a.render(Object(r.jsx)(c.a.StrictMode,{children:Object(r.jsx)(x,{})}),document.getElementById("root"))}},[[311,1,2]]]);
//# sourceMappingURL=main.d02e8974.chunk.js.map