(this.webpackJsonpdemo=this.webpackJsonpdemo||[]).push([[0],{257:function(e,t,n){var r=n(310),c=["infer"];e.exports=function(){var e=new Worker(n.p+"1e950416639f52d561e3.worker.js",{name:"[hash].worker.js"});return r(e,c),e}},287:function(e,t,n){},289:function(e,t,n){},296:function(e,t){},297:function(e,t){},305:function(e,t){},308:function(e,t){},309:function(e,t){},311:function(e,t,n){"use strict";n.r(t);var r=n(38),c=n(32),a=n.n(c),i=n(236),o=n.n(i),s=(n(287),n(68)),u=n(5),l=n.n(u),d=n(14),h=n(8),j=(n(289),n(259)),b=n(104),f=n(257),v=n.n(f),m=function(e){var t=e.data,n=e.shape;return b.c(t,n)},p=n(1),g=n(258),O=function(e){var t=e.inputImage,n=e.depthMapImage,a=e.viewMode,i=e.mousePosition,o=e.orientation,s=e.parallaxStrength,u=e.focus,l=e.zoom,d=Object(c.useRef)(null),h=Object(c.useRef)(null),j=Object(c.useRef)(null),b=Object(c.useRef)(null),f=Object(c.useRef)(null),v=Object(c.useRef)(null),m=Object(c.useRef)(null),O=Object(c.useRef)(null),x=Object(c.useCallback)((function(){if(d.current&&h.current&&b.current&&d.current.parentElement){var e=d.current.parentElement,t=e.clientWidth,n=e.clientHeight;if(h.current.setSize(t,n),b.current.aspect=t/n,b.current.updateProjectionMatrix(),O.current&&v.current){var r,c=v.current.image.width/v.current.image.height,a=b.current.fov,i=b.current.position.z,o=t/n,s=2*Math.tan(p.mb.degToRad(a/2))*i;r=o>c?s/1:s*o/c,O.current.scale.set(r,r,1)}}}),[]);Object(c.useEffect)((function(){var e=d.current,t=new g.a({canvas:e,antialias:!0});t.setSize(e.clientWidth,e.clientHeight),t.setPixelRatio(window.devicePixelRatio),h.current=t;var n=new p.Uc;j.current=n;var r=new p.Wb(45,e.clientWidth/e.clientHeight,.1,1e3);r.position.z=2,b.current=r;new p.Yb(1,1);var c=new p.Vc({vertexShader:"\n  attribute float depth;\n  varying vec2 vUv;\n  uniform vec2 mouseDelta;\n  uniform float focus;\n  uniform float meshDepth;\n  uniform float sensitivity;\n\n  void main() {\n    vUv = uv;\n    vec3 pos = position;\n\n    float actualDepth = depth * meshDepth;\n    float focusDepth = focus * meshDepth;\n\n    // Rotational displacement (relative to focus depth)\n    vec2 rotate = mouseDelta * sensitivity * \n        (1.0 - focus) * \n        (actualDepth - focusDepth) * \n        vec2(-1.0, 1.0);\n\n    // Calculate edge proximity factor (0 at edges, 1 in center)\n    float edgeWidth = 0.01; // controls edge stiffness\n    vec2 edgeFactorVec = smoothstep(0.0, edgeWidth, vUv) * \n                        smoothstep(1.0, 1.0 - edgeWidth, vUv);\n    float edgeFactor = edgeFactorVec.x * edgeFactorVec.y;\n\n    // Apply displacement with edge preservation\n    pos.xy += rotate * edgeFactor;\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n  }\n",fragmentShader:"\n  uniform sampler2D u_image;\n  varying vec2 vUv;\n\n  void main() {\n    gl_FragColor = texture2D(u_image, vUv);\n  }\n",uniforms:{u_image:{value:null},mouseDelta:{value:new p.qd(0,0)},focus:{value:u},meshDepth:{value:1},sensitivity:{value:.5}}});f.current=c;return function e(){requestAnimationFrame(e),t.render(n,r)}(),window.addEventListener("resize",x),x(),function(){window.removeEventListener("resize",x),h.current&&h.current.dispose(),v.current&&v.current.dispose(),m.current&&m.current.dispose()}}),[x]),Object(c.useEffect)((function(){f.current&&t&&(v.current&&v.current.dispose(),(new p.ed).load(t,(function(e){v.current=e,f.current.uniforms.u_image.value=e})))}),[t]);return Object(c.useEffect)((function(){if(O.current&&(j.current.remove(O.current),O.current.geometry.dispose(),O.current=null),f.current&&n&&j.current){var e=new Image;e.src=n,e.onload=function(){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var n=t.getContext("2d");n.drawImage(e,0,0);var r=function(e){for(var t=e.width,n=e.height,r=t/n,c=new p.Yb(r,1,t-1,n-1),a=c.attributes.position.array,i=new Float32Array(a.length/3),o=0;o<a.length;o+=3){var s=o/3,u=c.attributes.uv.array[2*s],l=1-c.attributes.uv.array[2*s+1],d=Math.floor(u*(t-1)),h=4*(Math.floor(l*(n-1))*t+d),j=e.data[h]/255;a[o+2]=j,i[s]=j}return c.setAttribute("depth",new p.l(i,1)),c.attributes.position.needsUpdate=!0,c}(n.getImageData(0,0,e.width,e.height)),c=new p.qb(r,f.current);O.current=c;var a,i=b.current.fov,o=b.current.position.z,s=d.current.clientWidth/d.current.clientHeight,u=e.width/e.height,l=2*Math.tan(p.mb.degToRad(i/2))*o;a=s>u?l/1:l*s/u,c.scale.set(a,a,1),j.current.add(c)}}}),[n]),Object(c.useEffect)((function(){if(f.current){var e=0,t=0;"mouse"===a&&i?(e=2*i.x-1,t=2*i.y-1):"gyro"===a&&o&&(e=o.gamma/30,t=o.beta/60);var n=f.current.uniforms.mouseDelta.value;n.x+=.05*(e-n.x),n.y+=.05*(t-n.y)}}),[i,o,a]),Object(c.useEffect)((function(){f.current&&(f.current.uniforms.focus.value=u)}),[u]),Object(c.useEffect)((function(){f.current&&(f.current.uniforms.sensitivity.value=10*s)}),[s]),Object(c.useEffect)((function(){b.current&&(b.current.position.z=2/l,b.current.updateProjectionMatrix())}),[l]),Object(r.jsx)("canvas",{ref:d,className:"main-view-canvas"})};var x=function(){var e=Object(c.useRef)(null),t=Object(c.useState)("demo.png"),n=Object(h.a)(t,2),a=n[0],i=n[1],o=Object(c.useState)(null),u=Object(h.a)(o,2),f=u[0],p=u[1],g=Object(c.useState)(!1),x=Object(h.a)(g,2),w=x[0],y=x[1],R=Object(c.useRef)(null),M=Object(c.useRef)(null),S=Object(c.useState)(!1),k=Object(h.a)(S,2),D=k[0],E=k[1],F=Object(c.useState)(/Mobi|Android/i.test(navigator.userAgent)?"gyro":"mouse"),N=Object(h.a)(F,2),z=N[0],C=N[1],P=Object(c.useState)({x:.5,y:.5}),I=Object(h.a)(P,2),U=I[0],W=I[1],A=Object(c.useState)(null),L=Object(h.a)(A,2),T=L[0],_=L[1],V=Object(c.useRef)(null),B=Object(c.useState)(!1),H=Object(h.a)(B,2),X=H[0],Y=H[1],q=Object(c.useState)(.02),J=Object(h.a)(q,2),G=J[0],K=J[1],Q=Object(c.useState)(.25),Z=Object(h.a)(Q,2),$=Z[0],ee=Z[1],te=Object(c.useState)(!1),ne=Object(h.a)(te,2),re=ne[0],ce=ne[1],ae=Object(c.useState)(1),ie=Object(h.a)(ae,2),oe=ie[0],se=ie[1],ue=Object(c.useState)(0),le=Object(h.a)(ue,2),de=le[0],he=le[1];Object(c.useEffect)((function(){e.current=new v.a}),[]),Object(c.useEffect)((function(){if(window.DeviceOrientationEvent){Y(!0);var e=function(e){"gyro"===z&&_({alpha:e.alpha,beta:e.beta,gamma:e.gamma})};return window.addEventListener("deviceorientation",e),function(){window.removeEventListener("deviceorientation",e)}}Y(!1)}),[z]);var je=Object(c.useCallback)(Object(d.a)(l.a.mark((function t(){var n,r,c,a,i;return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.current){t.next=4;break}return console.error("Inference worker is not initialized yet."),alert("Worker not ready, please try again shortly."),t.abrupt("return");case 4:if(!D&&R.current&&R.current.src&&""!==R.current.src){t.next=6;break}return t.abrupt("return");case 6:return E(!0),M.current&&M.current.getContext("2d").clearRect(0,0,M.current.width,M.current.height),p(null),y(!1),t.prev=10,n=b.a.fromPixels(R.current),r=[n.shape[0],n.shape[1]],n=b.b.resizeBilinear(n,[256,256]),c={data:(o=n).dataSync(),shape:o.shape},n.dispose(),t.t0=m,t.next=19,e.current.infer(c);case 19:if(t.t1=t.sent,a=(0,t.t0)(t.t1),a=b.b.resizeBilinear(a,r),!M.current){t.next=27;break}return M.current.width=r[1],M.current.height=r[0],t.next=27,b.a.toPixels(a,M.current);case 27:return(i=document.createElement("canvas")).width=r[1],i.height=r[0],t.next=32,b.a.toPixels(a.clone(),i);case 32:p(i.toDataURL()),y(!0),a.dispose(),t.next=41;break;case 37:t.prev=37,t.t2=t.catch(10),console.error("Inference error:",t.t2),alert("An unknown error occurred during inference.");case 41:return t.prev=41,E(!1),t.finish(41);case 44:case"end":return t.stop()}var o}),t,null,[[10,37,41,44]])}))),[D,R,M,p,E]),be=Object(c.useCallback)((function(e){if(!D){var t=new FileReader;t.onload=function(){if(i(t.result),p(null),y(!1),M.current){var e=M.current.getContext("2d");M.current.width>0&&M.current.height>0&&e.clearRect(0,0,M.current.width,M.current.height)}},t.readAsDataURL(e[0])}}),[i,p,D,M]),fe=Object(j.a)({onDrop:be,accept:"image/*"}),ve=fe.getRootProps,me=fe.getInputProps,pe=fe.isDragActive,ge=function(e){if("mouse"===z&&V.current){var t=V.current.getBoundingClientRect(),n=e.touches?e.touches[0].clientX:e.clientX,r=e.touches?e.touches[0].clientY:e.clientY,c=(n-t.left)/t.width,a=(r-t.top)/t.height;W({x:Math.max(0,Math.min(1,c)),y:Math.max(0,Math.min(1,1-a))})}},Oe=function(){ce(!re)};return Object(r.jsxs)("div",{className:"app-container",children:[Object(r.jsxs)("button",{className:"hamburger-menu",onClick:Oe,children:[Object(r.jsx)("span",{}),Object(r.jsx)("span",{}),Object(r.jsx)("span",{})]}),re&&Object(r.jsx)("div",{className:"overlay",onClick:Oe}),Object(r.jsxs)("aside",{className:"sidebar ".concat(re?"sidebar--open":""),onTouchStart:function(e){he(e.touches[0].clientX)},onTouchMove:function(e){re&&(e.touches[0].clientX-de<-50&&ce(!1))},children:[Object(r.jsx)("h2",{children:"\u63a7\u5236\u53f0"}),Object(r.jsxs)("div",{className:"control-group",children:[Object(r.jsx)("label",{htmlFor:"viewModeSelect",children:"\u63a7\u5236\u6a21\u5f0f"}),Object(r.jsxs)("select",{id:"viewModeSelect",value:z,onChange:function(e){return C(e.target.value)},children:[Object(r.jsx)("option",{value:"mouse",children:"\u9f20\u6807"}),X&&Object(r.jsx)("option",{value:"gyro",children:"\u9640\u87ba\u4eea"})]}),!X&&"gyro"===z&&Object(r.jsx)("p",{style:{color:"orange"},children:"\u9640\u87ba\u4eea\u4e0d\u53ef\u7528\u6216\u4e0d\u652f\u6301\u3002"})]}),Object(r.jsxs)("div",{className:"control-group",children:[Object(r.jsxs)("label",{htmlFor:"parallaxStrengthRange",children:["\u4f4d\u79fb\u5f3a\u5ea6: ",G.toFixed(3)]}),Object(r.jsx)("input",{type:"range",id:"parallaxStrengthRange",min:"0.001",max:"0.1",step:"0.001",value:G,onChange:function(e){return K(parseFloat(e.target.value))},onTouchMove:function(e){return e.stopPropagation()}})]}),Object(r.jsxs)("div",{className:"control-group",children:[Object(r.jsxs)("label",{htmlFor:"focusRange",children:["\u7126\u70b9: ",$.toFixed(2)]}),Object(r.jsx)("input",{type:"range",id:"focusRange",min:"0.0",max:"1.0",step:"0.01",value:$,onChange:function(e){return ee(parseFloat(e.target.value))},onTouchMove:function(e){return e.stopPropagation()}})]}),Object(r.jsxs)("div",{className:"image-preview-area",children:[Object(r.jsx)("h3",{children:"\u539f\u59cb\u56fe\u50cf"}),Object(r.jsxs)("div",Object(s.a)(Object(s.a)({className:["image-dropzone",pe?"image-dropzone--highlight":"image-dropzone--default"].join(" ")},ve()),{},{children:[Object(r.jsx)("input",Object(s.a)({},me())),a?Object(r.jsx)("img",{ref:R,alt:"Input",src:a,className:"preview-image",onLoad:je}):Object(r.jsx)("p",{children:"Drop an image here, or click to select"})]}))]}),Object(r.jsxs)("div",{className:"image-preview-area",children:[Object(r.jsx)("h3",{children:"\u6df1\u5ea6\u56fe"}),Object(r.jsx)("canvas",{ref:M,className:"preview-image"})]}),Object(r.jsx)("button",{onClick:je,disabled:D||!a,children:D?"\u751f\u6210\u4e2d...":"\u751f\u6210\u6df1\u5ea6\u56fe"}),Object(r.jsx)("div",{className:"made-by-text",children:"Made by J"})]}),Object(r.jsxs)("main",{className:"main-content",onMouseMove:ge,onTouchMove:ge,ref:V,children:[Object(r.jsx)("h1",{className:"main-title",children:"\u5355\u76ee\u6df1\u5ea6\u56fe\u4f30\u7b97"}),Object(r.jsxs)("div",{className:"webgl-viewer-container",children:[D&&!w&&Object(r.jsx)("div",{className:"loading-overlay",children:Object(r.jsx)("p",{children:"\u751f\u6210\u4e2d..."})}),Object(r.jsx)(O,{inputImage:a,depthMapImage:w?f:null,viewMode:z,mousePosition:U,orientation:T,parallaxStrength:G,focus:$,zoom:oe}),Object(r.jsxs)("div",{className:"viewer-controls",children:[Object(r.jsx)("button",{onClick:function(){return se(.9)},children:"\u91cd\u7f6e"}),Object(r.jsxs)("label",{htmlFor:"zoomRange",children:[oe.toFixed(2),"x"]}),Object(r.jsx)("input",{type:"range",id:"zoomRange",min:"0.1",max:"1.5",step:"0.1",value:oe,onChange:function(e){return se(parseFloat(e.target.value))}})]})]})]})]})};o.a.render(Object(r.jsx)(a.a.StrictMode,{children:Object(r.jsx)(x,{})}),document.getElementById("root"))}},[[311,1,2]]]);
//# sourceMappingURL=main.bd665c8d.chunk.js.map