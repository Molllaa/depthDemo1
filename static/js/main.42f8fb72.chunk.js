(this.webpackJsonpdemo=this.webpackJsonpdemo||[]).push([[0],{257:function(e,t,n){var r=n(310),c=["isModelLoaded","switchModel","infer"];e.exports=function(){var e=new Worker(n.p+"5048cbc94aa7c76adbed.worker.js",{name:"[hash].worker.js"});return r(e,c),e}},287:function(e,t,n){},289:function(e,t,n){},296:function(e,t){},297:function(e,t){},305:function(e,t){},308:function(e,t){},309:function(e,t){},311:function(e,t,n){"use strict";n.r(t);var r=n(36),c=n(32),a=n.n(c),i=n(236),o=n.n(i),s=(n(287),n(68)),u=n(5),l=n.n(u),d=n(14),h=n(8),j=(n(289),n(259)),b=n(109),v=n(257),f=n.n(v),p=function(e){var t=e.data,n=e.shape;return b.c(t,n)},m=n(1),g=n(258),O=function(e){var t=e.inputImage,n=e.depthMapImage,a=e.viewMode,i=e.mousePosition,o=e.orientation,s=e.parallaxStrength,u=e.focus,l=e.zoom,d=Object(c.useRef)(null),h=Object(c.useRef)(null),j=Object(c.useRef)(null),b=Object(c.useRef)(null),v=Object(c.useRef)(null),f=Object(c.useRef)(null),p=Object(c.useRef)(null),O=Object(c.useRef)(null),x=Object(c.useCallback)((function(){if(d.current&&h.current&&b.current&&d.current.parentElement){var e=d.current.parentElement,t=e.clientWidth,n=e.clientHeight;if(h.current.setSize(t,n),b.current.aspect=t/n,b.current.updateProjectionMatrix(),O.current&&f.current){var r,c=f.current.image.width/f.current.image.height,a=b.current.fov,i=b.current.position.z,o=t/n,s=2*Math.tan(m.mb.degToRad(a/2))*i;r=o>c?s/1:s*o/c,O.current.scale.set(r,r,1)}}}),[]);Object(c.useEffect)((function(){var e=d.current,t=new g.a({canvas:e,antialias:!0});t.setSize(e.clientWidth,e.clientHeight),t.setPixelRatio(window.devicePixelRatio),h.current=t;var n=new m.Uc;j.current=n;var r=new m.Wb(45,e.clientWidth/e.clientHeight,.1,1e3);r.position.z=2,b.current=r;new m.Yb(1,1);var c=new m.Vc({vertexShader:"\n  attribute float depth;\n  varying vec2 vUv;\n  uniform vec2 mouseDelta;\n  uniform float focus;\n  uniform float meshDepth;\n  uniform float sensitivity;\n\n  void main() {\n    vUv = uv;\n    vec3 pos = position;\n\n    float actualDepth = depth * meshDepth;\n    float focusDepth = focus * meshDepth;\n\n    // Rotational displacement (relative to focus depth)\n    vec2 rotate = mouseDelta * sensitivity * \n        (1.0 - focus) * \n        (actualDepth - focusDepth) * \n        vec2(-1.0, 1.0);\n\n    // Calculate edge proximity factor (0 at edges, 1 in center)\n    float edgeWidth = 0.01; // controls edge stiffness\n    vec2 edgeFactorVec = smoothstep(0.0, edgeWidth, vUv) * \n                        smoothstep(1.0, 1.0 - edgeWidth, vUv);\n    float edgeFactor = edgeFactorVec.x * edgeFactorVec.y;\n\n    // Apply displacement with edge preservation\n    pos.xy += rotate * edgeFactor;\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);\n  }\n",fragmentShader:"\n  uniform sampler2D u_image;\n  varying vec2 vUv;\n\n  void main() {\n    gl_FragColor = texture2D(u_image, vUv);\n  }\n",uniforms:{u_image:{value:null},mouseDelta:{value:new m.qd(0,0)},focus:{value:u},meshDepth:{value:1},sensitivity:{value:.5}}});v.current=c;return function e(){requestAnimationFrame(e),t.render(n,r)}(),window.addEventListener("resize",x),x(),function(){window.removeEventListener("resize",x),h.current&&h.current.dispose(),f.current&&f.current.dispose(),p.current&&p.current.dispose()}}),[x]),Object(c.useEffect)((function(){v.current&&t&&(f.current&&f.current.dispose(),(new m.ed).load(t,(function(e){f.current=e,v.current.uniforms.u_image.value=e})))}),[t]);return Object(c.useEffect)((function(){if(O.current&&(j.current.remove(O.current),O.current.geometry.dispose(),O.current=null),v.current&&n&&j.current){var e=new Image;e.src=n,e.onload=function(){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var n=t.getContext("2d");n.drawImage(e,0,0);var r=function(e){for(var t=e.width,n=e.height,r=t/n,c=new m.Yb(r,1,t-1,n-1),a=c.attributes.position.array,i=new Float32Array(a.length/3),o=0;o<a.length;o+=3){var s=o/3,u=c.attributes.uv.array[2*s],l=1-c.attributes.uv.array[2*s+1],d=Math.floor(u*(t-1)),h=4*(Math.floor(l*(n-1))*t+d),j=e.data[h]/255;a[o+2]=j,i[s]=j}return c.setAttribute("depth",new m.l(i,1)),c.attributes.position.needsUpdate=!0,c}(n.getImageData(0,0,e.width,e.height)),c=new m.qb(r,v.current);O.current=c;var a,i=b.current.fov,o=b.current.position.z,s=d.current.clientWidth/d.current.clientHeight,u=e.width/e.height,l=2*Math.tan(m.mb.degToRad(i/2))*o;a=s>u?l/1:l*s/u,c.scale.set(a,a,1),j.current.add(c)}}}),[n]),Object(c.useEffect)((function(){if(v.current){var e=0,t=0;"mouse"===a&&i?(e=2*i.x-1,t=2*i.y-1):"gyro"===a&&o?(e=o.gamma/-30,t=o.beta/-60):"gyroInverse"===a&&o&&(e=o.gamma/30,t=o.beta/60);var n=v.current.uniforms.mouseDelta.value;n.x+=.05*(e-n.x),n.y+=.05*(t-n.y)}}),[i,o,a]),Object(c.useEffect)((function(){v.current&&(v.current.uniforms.focus.value=u)}),[u]),Object(c.useEffect)((function(){v.current&&(v.current.uniforms.sensitivity.value=10*s)}),[s]),Object(c.useEffect)((function(){b.current&&(b.current.position.z=2/l,b.current.updateProjectionMatrix())}),[l]),Object(r.jsx)("canvas",{ref:d,className:"main-view-canvas"})};var x=function(){var e=Object(c.useRef)(null),t=Object(c.useState)(""),n=Object(h.a)(t,2),a=n[0],i=n[1],o=Object(c.useState)(null),u=Object(h.a)(o,2),v=u[0],m=u[1],g=Object(c.useState)(!1),x=Object(h.a)(g,2),w=x[0],y=x[1],M=Object(c.useRef)(null),R=Object(c.useRef)(null),S=Object(c.useState)(!1),k=Object(h.a)(S,2),E=k[0],D=k[1],F=Object(c.useState)(!1),N=Object(h.a)(F,2),z=N[0],C=N[1],I=Object(c.useState)(/Mobi|Android/i.test(navigator.userAgent)?"gyro":"mouse"),P=Object(h.a)(I,2),A=P[0],T=P[1],W=Object(c.useState)({x:.5,y:.5}),L=Object(h.a)(W,2),U=L[0],_=L[1],H=Object(c.useState)(null),V=Object(h.a)(H,2),X=V[0],Y=V[1],q=Object(c.useRef)(null),B=Object(c.useState)(!1),J=Object(h.a)(B,2),G=J[0],K=J[1],Q=Object(c.useState)(.025),Z=Object(h.a)(Q,2),$=Z[0],ee=Z[1],te=Object(c.useState)(.75),ne=Object(h.a)(te,2),re=ne[0],ce=ne[1],ae=Object(c.useState)(!1),ie=Object(h.a)(ae,2),oe=ie[0],se=ie[1],ue=Object(c.useState)(.9),le=Object(h.a)(ue,2),de=le[0],he=le[1],je=Object(c.useState)("depthAnything"),be=Object(h.a)(je,2),ve=be[0],fe=be[1],pe=Object(c.useState)(0),me=Object(h.a)(pe,2),ge=me[0],Oe=me[1];Object(c.useEffect)((function(){e.current=new f.a;var t=function(){var n=Object(d.a)(l.a.mark((function n(){var r;return l.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,e.current.isModelLoaded(ve);case 3:r=n.sent,C(r),r||setTimeout(t,1e3),n.next=12;break;case 8:n.prev=8,n.t0=n.catch(0),console.error("Error checking model loaded status:",n.t0),setTimeout(t,1e3);case 12:case"end":return n.stop()}}),n,null,[[0,8]])})));return function(){return n.apply(this,arguments)}}();t()}),[]),Object(c.useEffect)((function(){e.current&&(C(!1),e.current.switchModel(ve).then((function(t){if(t){var n=function(){var t=Object(d.a)(l.a.mark((function t(){var r;return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.current.isModelLoaded(ve);case 3:r=t.sent,C(r),r?a&&!E&&xe():setTimeout(n,1e3),t.next=12;break;case 8:t.prev=8,t.t0=t.catch(0),console.error("Error checking model loaded status:",t.t0),setTimeout(n,1e3);case 12:case"end":return t.stop()}}),t,null,[[0,8]])})));return function(){return t.apply(this,arguments)}}();n()}})))}),[ve]),Object(c.useEffect)((function(){if(window.DeviceOrientationEvent){K(!0);var e=function(e){"gyro"!==A&&"gyroInverse"!==A||Y({alpha:e.alpha,beta:e.beta,gamma:e.gamma})};return window.addEventListener("deviceorientation",e),function(){window.removeEventListener("deviceorientation",e)}}K(!1)}),[A]);var xe=Object(c.useCallback)(Object(d.a)(l.a.mark((function t(){var n,r,c,a,i;return l.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.current){t.next=4;break}return console.error("Inference worker is not initialized yet."),alert("Worker not ready, please try again shortly."),t.abrupt("return");case 4:if(z){t.next=8;break}return console.error("Model is not loaded yet."),alert("\u6a21\u578b\u5c1a\u672a\u52a0\u8f7d\u5b8c\u6210\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002"),t.abrupt("return");case 8:if(!E&&M.current&&M.current.src&&""!==M.current.src&&0!==M.current.naturalWidth&&0!==M.current.naturalHeight){t.next=10;break}return t.abrupt("return");case 10:return D(!0),R.current&&R.current.getContext("2d").clearRect(0,0,R.current.width,R.current.height),m(null),y(!1),t.prev=14,n=b.a.fromPixels(M.current),r=[n.shape[0],n.shape[1]],4===n.shape[2]&&(n=n.slice([0,0,0],[n.shape[0],n.shape[1],3])),c={data:(o=n).dataSync(),shape:o.shape},n.dispose(),t.t0=p,t.next=23,e.current.infer(c);case 23:if(t.t1=t.sent,a=(0,t.t0)(t.t1),a=b.b.resizeBilinear(a,r),!R.current){t.next=31;break}return R.current.width=r[1],R.current.height=r[0],t.next=31,b.a.toPixels(a,R.current);case 31:return(i=document.createElement("canvas")).width=r[1],i.height=r[0],t.next=36,b.a.toPixels(a.clone(),i);case 36:m(i.toDataURL()),y(!0),a.dispose(),t.next=45;break;case 41:t.prev=41,t.t2=t.catch(14),console.error("Inference error:",t.t2),alert("An unknown error occurred during inference.");case 45:return t.prev=45,D(!1),t.finish(45);case 48:case"end":return t.stop()}var o}),t,null,[[14,41,45,48]])}))),[E,M,R,m,D,ve,z]),we=Object(c.useCallback)((function(e){if(!E&&z){var t=new FileReader;t.onload=function(){if(i(t.result),m(null),y(!1),R.current){var e=R.current.getContext("2d");R.current.width>0&&R.current.height>0&&e.clearRect(0,0,R.current.width,R.current.height)}},t.readAsDataURL(e[0])}}),[i,m,E,R,z]),ye=Object(j.a)({onDrop:we,accept:"image/*"}),Me=ye.getRootProps,Re=ye.getInputProps,Se=ye.isDragActive,ke=function(e){if("mouse"===A&&q.current){var t=q.current.getBoundingClientRect(),n=e.touches?e.touches[0].clientX:e.clientX,r=e.touches?e.touches[0].clientY:e.clientY,c=(n-t.left)/t.width,a=(r-t.top)/t.height;_({x:Math.max(0,Math.min(1,c)),y:Math.max(0,Math.min(1,1-a))})}},Ee=function(){se(!oe)};return Object(r.jsxs)("div",{className:"app-container",children:[Object(r.jsxs)("button",{className:"hamburger-menu",onClick:Ee,children:[Object(r.jsx)("span",{}),Object(r.jsx)("span",{}),Object(r.jsx)("span",{})]}),oe&&Object(r.jsx)("div",{className:"overlay",onClick:Ee}),Object(r.jsxs)("aside",{className:"sidebar ".concat(oe?"sidebar--open":""),onTouchStart:function(e){Oe(e.touches[0].clientX)},onTouchMove:function(e){oe&&(e.touches[0].clientX-ge<-50&&se(!1))},children:[Object(r.jsx)("h2",{children:"\u63a7\u5236\u53f0"}),Object(r.jsxs)("div",{className:"control-group",children:[Object(r.jsx)("label",{htmlFor:"modelSelect",children:"\u9009\u62e9\u6a21\u578b"}),Object(r.jsxs)("select",{id:"modelSelect",value:ve,onChange:function(e){return fe(e.target.value)},children:[Object(r.jsx)("option",{value:"depthAnything",children:"DepthAnything"}),Object(r.jsx)("option",{value:"midas",children:"Midas"})]}),Object(r.jsx)("label",{htmlFor:"viewModeSelect",children:"\u63a7\u5236\u6a21\u5f0f"}),Object(r.jsxs)("select",{id:"viewModeSelect",value:A,onChange:function(e){return T(e.target.value)},children:[Object(r.jsx)("option",{value:"mouse",children:"\u9f20\u6807"}),G&&Object(r.jsx)("option",{value:"gyro",children:"\u9640\u87ba\u4eea"}),G&&Object(r.jsx)("option",{value:"gyroInverse",children:"\u9640\u87ba\u4eea(\u53cd\u5411)"})]}),!G&&("gyro"===A||"gyroInverse"===A)&&Object(r.jsx)("p",{style:{color:"orange"},children:"\u9640\u87ba\u4eea\u4e0d\u53ef\u7528\u6216\u4e0d\u652f\u6301\u3002"})]}),Object(r.jsxs)("div",{className:"control-group",children:[Object(r.jsxs)("label",{htmlFor:"parallaxStrengthRange",children:["\u4f4d\u79fb\u5f3a\u5ea6: ",$.toFixed(3)]}),Object(r.jsx)("input",{type:"range",id:"parallaxStrengthRange",min:"0.001",max:"0.1",step:"0.001",value:$,onChange:function(e){return ee(parseFloat(e.target.value))},onTouchMove:function(e){return e.stopPropagation()}})]}),Object(r.jsxs)("div",{className:"control-group",children:[Object(r.jsxs)("label",{htmlFor:"focusRange",children:["\u7126\u70b9: ",re.toFixed(2)]}),Object(r.jsx)("input",{type:"range",id:"focusRange",min:"0.0",max:"1.0",step:"0.01",value:re,onChange:function(e){return ce(parseFloat(e.target.value))},onTouchMove:function(e){return e.stopPropagation()}})]}),Object(r.jsxs)("div",{className:"image-preview-area",children:[Object(r.jsx)("h3",{children:"\u539f\u59cb\u56fe\u50cf"}),Object(r.jsxs)("div",Object(s.a)(Object(s.a)({className:["image-dropzone",z?Se?"image-dropzone--highlight":"image-dropzone--default":"image-dropzone--disabled"].join(" ")},z?Me():{}),{},{children:[z&&Object(r.jsx)("input",Object(s.a)({},Re())),a?Object(r.jsx)("img",{ref:M,alt:"Input",src:a,className:"preview-image",onLoad:z?xe:void 0}):Object(r.jsx)("p",{children:z?"\u70b9\u51fb\u4e0a\u4f20\uff0c\u6216\u62d6\u62fd\u56fe\u7247\u81f3\u6b64\u5904":"\u6a21\u578b\u52a0\u8f7d\u4e2d..."})]}))]}),Object(r.jsxs)("div",{className:"image-preview-area",children:[Object(r.jsx)("h3",{children:"\u6df1\u5ea6\u56fe"}),Object(r.jsx)("canvas",{ref:R,className:"preview-image"})]}),Object(r.jsx)("button",{onClick:xe,disabled:E||!a||!z,children:E?"\u751f\u6210\u4e2d...":z?"\u751f\u6210\u6df1\u5ea6\u56fe":"\u6a21\u578b\u52a0\u8f7d\u4e2d..."}),Object(r.jsx)("div",{className:"made-by-text",children:"Made by J"})]}),Object(r.jsxs)("main",{className:"main-content",onMouseMove:ke,onTouchMove:ke,ref:q,children:[Object(r.jsx)("h1",{className:"main-title",children:"\u5355\u76ee\u6df1\u5ea6\u56fe\u4f30\u7b97"}),Object(r.jsxs)("div",{className:"webgl-viewer-container",children:[E&&!w&&Object(r.jsx)("div",{className:"loading-overlay",children:Object(r.jsx)("p",{children:"\u751f\u6210\u4e2d..."})}),Object(r.jsx)(O,{inputImage:a,depthMapImage:w?v:null,viewMode:A,mousePosition:U,orientation:X,parallaxStrength:$,focus:re,zoom:de}),Object(r.jsxs)("div",{className:"viewer-controls",children:[Object(r.jsx)("button",{onClick:function(){he(.9),_({x:.5,y:.5})},children:"\u91cd\u7f6e"}),Object(r.jsxs)("label",{htmlFor:"zoomRange",children:[de.toFixed(2),"x"]}),Object(r.jsx)("input",{type:"range",id:"zoomRange",min:"0.1",max:"1.5",step:"0.1",value:de,onChange:function(e){return he(parseFloat(e.target.value))}})]})]})]})]})};o.a.render(Object(r.jsx)(a.a.StrictMode,{children:Object(r.jsx)(x,{})}),document.getElementById("root"))}},[[311,1,2]]]);
//# sourceMappingURL=main.42f8fb72.chunk.js.map